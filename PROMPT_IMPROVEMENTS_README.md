# 提示词改进方案 - 解决工具误用问题

## 问题描述

系统遇到以下问题：
```
2025-08-17 14:09:33,463 - TaskEngine - INFO - 工具返回摘要: tool=enhanced_report_generator status=error message=此工具专门用于生成专业报告，不适用于以下场景：
• 简单知识查询（如人物、历史事件查询）- 请使用搜索工具
• 日常问候或闲聊对话
• 单纯的搜索请求
适用场景：明确要求生成报告、分析、总结等专业文档时使用 error=内容不适合生成专业报告
```

**根本原因**：
1. TaskEngine 模式检测误判：将"吃了吗？您那..."这类问候误判为"任务模式"
2. LLM 计划生成选择不当：为简单查询选择了 `enhanced_report_generator`

## 解决方案

### 1. 改善模式检测提示词

**文件**: `core/task_engine.py` -> `_llm_detect_task_mode_universal`

**改进内容**：
- 增加更多闲聊示例，特别是不完整的问候语句
- 添加"重要提示"部分，强调社交性质的判断优先级
- 明确指出不完整或模糊的表达如果是社交性质应归类为闲聊

**关键改进**：
```python
• 问候寒暄："你好"、"吃了吗"、"最近怎么样"、"身体好吗"、"您那..."、"吃了吗？您那..."
• 不完整的问候：句子不完整或被截断的社交性表达
• 简单回复：单纯的确认、感叹或简短反应

重要提示：
- 如果查询显然是社交性质的对话（问候、关怀、感谢等），即使有疑问词也应归类为【闲聊对话】
- 只有明确需要查找信息、执行任务或使用工具的查询才是【任务请求】
- 不完整或模糊的表达，如果明显是社交性质，应归类为【闲聊对话】
```

### 2. 改善计划生成提示词

**文件**: `core/task_engine.py` -> `_generate_plan`

**改进内容**：
- 添加"工具选择指导原则"部分
- 明确 `enhanced_report_generator` 的适用和不适用场景
- 强调搜索工具应优先用于信息查询

**关键改进**：
```python
工具选择指导原则：
1. enhanced_report_generator：仅用于需要生成专业报告、分析报告、研究报告的场景
   - 适用：明确要求"生成报告"、"分析总结"、"详细研究"等
   - 不适用：简单信息查询、人物询问、概念解释等
2. 搜索类工具（如baidu_search、web_search等）：用于信息查询、知识获取
   - 适用：查询人物信息、历史事件、概念解释、实时信息等
   - 首选用于回答"谁是XX"、"什么是XX"、"XX的信息"等查询
```

### 3. 改善错误提示友好性

**文件**: `tools/enhanced_report_generator.py`

**改进内容**：
- 使用更友好的语言和emoji
- 提供明确的建议而非仅仅拒绝
- 解释工具的正确用途

**关键改进**：
```python
error_msg = "该查询更适合直接回答，无需生成专业报告。\n\n"
error_msg += "🔍 enhanced_report_generator 专门用于：\n"
error_msg += "• 生成专业分析报告\n"
error_msg += "• 整理大量数据资料\n"
error_msg += "• 撰写研究总结文档\n\n"
error_msg += "💡 对于您的查询，建议：\n"
error_msg += "• 简单信息查询 → 使用搜索工具\n"
error_msg += "• 日常对话交流 → 直接回答即可\n"
error_msg += "• 如需专业报告 → 请明确说明报告需求"
```

## 预期效果

### 改进前
- "吃了吗？您那..."被误判为任务模式
- LLM 选择 `enhanced_report_generator` 处理
- 工具拒绝并返回严厉的错误信息

### 改进后
- 更准确识别社交性问候为闲聊模式
- 即使误判为任务，LLM 也会选择更合适的工具（如搜索）
- 如果仍然误选工具，错误提示更友好和有建设性

## 测试验证

运行测试文件验证改进效果：
```bash
python test_prompt_improvements.py
```

测试覆盖：
1. 模式检测准确率测试
2. 工具错误提示改善验证  
3. 完整任务执行流水线测试

## 核心改进原理

**提示词工程的关键**：
1. **具体化示例**：增加更多具体的边缘情况示例
2. **优先级指导**：明确判断规则的优先级
3. **上下文理解**：帮助模型理解社交vs信息性查询的区别
4. **工具映射清晰化**：明确每个工具的适用场景

**改善效果**：
- ✅ 减少模式误判
- ✅ 优化工具选择
- ✅ 提升用户体验
- ✅ 增强系统鲁棒性

## 持续优化建议

1. **数据收集**：收集更多误判案例，持续优化提示词
2. **A/B测试**：对比不同提示词版本的效果
3. **用户反馈**：建立反馈机制，根据用户体验调整
4. **规则扩展**：根据新发现的边缘情况扩展判断规则

这种基于提示词工程的方法可以显著改善系统的智能化程度和用户体验，而无需修改底层架构。 