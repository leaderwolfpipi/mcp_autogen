#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
调试内容提取问题
深入分析为什么没有提取到有效信息
"""

import json
from tools.llm_report_generator import _extract_content, _build_professional_prompt

def debug_content_extraction():
    """调试内容提取问题"""
    print("🔍 调试内容提取问题")
    print("=" * 60)
    
    # 模拟您提供的真实数据
    test_data = [
        {
            'title': '諸葛亮- 維基百科，自由的百科全書',
            'link': 'https://zh.wikipedia.org/wiki/%E8%AF%B8%E8%91%9B%E4%BA%AE',
            'snippet': ' 諸葛亮是漢司隸校尉諸葛豐後；父親諸葛珪，字君貢，漢末為泰山郡丞。 漢靈帝光和四年（181年），諸葛亮生於琅琊陽都。 不久母親章氏去世，父親續娶。 中平五年（188年），諸葛亮的父\xa0... ',
            'full_content': '''諸葛亮蜀漢丞相、政治家、軍事家前任：無（首任）繼任：無（廢除）清殿藏本諸葛孔明像丞相錄尚書事加開府治事领司隶校尉兼益州牧國家東漢 → 蜀漢時代東漢末年至三國时期主君劉備 → 劉禪姓諸葛名亮字孔明號臥龍封爵武鄉侯（蜀汉封）武兴王（东晋追封）安国王（前蜀追封）封地武鄉出身地徐州琅琊郡世系琅琊諸葛氏出生漢靈帝光和四年（181年）東漢琅琊郡陽都縣（今山東省临沂市沂南縣）逝世蜀漢後主建興十二年農曆八月（234年）五丈原（今陕西省岐山縣五丈原镇）谥号忠武墓葬漢中定軍山祠廟武侯祠親屬父親诸葛珪母親章氏繼母顧氏正室黃夫人正室之父黃承彥正室之母蔡氏兄弟諸葛瑾、諸葛均姊妹佚名（夫龐山民）、佚名（夫蒯祺）子諸葛瞻養子諸葛喬（諸葛瑾過繼）其他親屬从父：諸葛玄孫兒：諸葛尚（與父諸葛瞻戰死於魏灭蜀之战）、諸葛京（仕晉官至江州刺史） 姻親： 蜀漢 繼子（監護對象）：劉禪（劉備子）繼兒媳：敬哀皇后（張飛長女）、張皇后（張飛次女） 其他同輩：費禕（諸葛瞻連襟費承之父）、關興（諸葛瞻連襟關統之父，關羽之子）、馬超（劉禪弟劉理岳父）、劉備（劉禪之父）、張飛（劉禪岳父）、夏侯霸（劉禪從內舅） 晚輩：姻侄劉璿、劉瑤、劉琮、劉瓚、劉諶、劉恂及劉璩（皆為劉禪兒子，諸葛瞻內兄/弟）、刘胤及劉輯（皆為劉禪弟劉理之子，諸葛瞻堂內兄/弟）、費承、關統，姻侄女費氏（劉璿太子妃，費禕之女） 東吳 姻伯孫權（姻伯劉備的內兄，因孫和故兼姻侄） 姻弟孫和（兼外侄孫婿，孫和太子妃之夫）、孫休（孫權六子）、孫亮（孫權七子） 姻侄孫皓（兼曾外侄孫，孫和長子） 曹魏 長輩： 姻舅公曹操（姻舅夏侯霸的姨丈）、夏侯淵（夏侯霸的父親，曹操連襟） 姻族舅公夏侯惇（夏侯淵族兄） 姻從表舅公曹仁、曹純、曹洪（曹操從弟） 姻堂舅夏侯尚（夏侯霸的堂兄弟） 姻表舅曹丕、曹彰、曹植及曹熊（皆為夏侯霸的表兄弟）、曹真（曹操的族侄）、曹休（曹操的族子） 姻表弟曹叡（曹丕獨子）及曹爽諸兄弟（曹真諸子） 姻表侄曹芳（曹叡養子）；曹髦及曹奐（皆為曹叡繼子） 西晉 姻兄司馬懿（堂侄女婿司馬伷之父） 姻侄司馬師及司馬昭（皆為司馬伷之兄） 姻侄孫司馬炎及司馬攸等（皆為司馬昭之子） 姻侄孫女婿甄德（司馬師及司馬昭女婿，曹叡堂妻舅） 東吳 侄兒：诸葛恪（遭孙峻族誅） 侄孫：诸葛绰、诸葛竦、诸葛建 侄兒：诸葛乔（養子） 侄孫：諸葛攀（自蜀漢返回東吳恢復諸葛瑾後人身份） 曾侄孫：諸葛顯（與諸葛京遷入西晉） 侄兒：诸葛融（遭孙峻族誅） 侄女：諸葛氏（張承妻） 外侄孫張震（遭孙峻族誅） 外侄孫女 孫和太子妃 曾外侄孫孫皓殺死自身胞弟孫俊 曾外侄孫女孫氏（陸景妻） 諸葛氏（陸抗妻，陸遜兒媳） 曾外侄孫陸景（孙皓妹夫） 曹魏及西晉 堂弟：諸葛誕 堂侄兒：诸葛靓 堂侄孫： 诸葛頤 诸葛恢 堂曾侄孫诸葛甝、诸葛虪、諸葛衡 堂曾侄孫女诸葛文彪（先為庾亮兒媳，再嫁江虨）、诸葛氏（羊楷妻，羊祜和羊徽瑜(司馬師妻，司馬懿兒媳)的堂侄孙媳）、诸葛文熊（謝石妻，謝安弟媳） 堂侄女： 諸葛氏（司馬伷妻、司馬懿兒媳） 堂外侄孫司馬繇 堂曾外侄孫司马睿 诸葛氏 （王凌兒媳，因王凌叛亂遭司馬懿族誅） 外甥：龐渙經歷 軍師中郎將 軍師將軍、署左將軍府事 署大司馬府事 丞相录尚书事暨假节 自貶為右將軍、行丞相事 復為丞相、加领司隶校尉 加封武鄉侯、開府治事 加領益州牧 著作《草庐對》、《為後帝伐魏詔》、《請宣大行皇帝遺詔表》、《出師表》、《自表後主》、《正議》、《絕盟好議》、《為法正答或問書》、《答關羽書》、《誡子書》、《誡外甥書》等 诸葛亮（181年—234年），字孔明，琅琊郡阳都县（今山東省临沂市沂南縣）人。三國時期蜀漢（季漢）丞相:2902，亦是政治家、军事家、发明家及散文家，曾发明木牛流马、诸葛连弩等。他常被後世認為是智慧和忠義的典範。先為劉備麾下核心幕僚，後主劉禅早期蜀漢實際上的最高領導人。 諸葛亮年輕時自比管仲、樂毅，人稱「卧龙」:2902。諸葛亮與徐元直、崔州平、石廣元、孟公威交好，與「鳳雛」龐統師出同門齊名。劉備三顧茅廬始見之，為劉備畫據荊益、聯合孫權、抗拒曹操之策，輔佐劉備取荊州，定益州，遂與曹魏、孫吳鼎足而三:2902。曹丕代漢，劉備稱帝於成都，以諸葛亮為丞相:2902。劉備死，諸葛亮輔助後主劉禪，以丞相封武乡侯，兼領益州牧:2902。 諸葛亮整官制，修法度，志復中原:2902。諸葛亮改善經濟，休養生息，打壓益州豪族，平定南中叛亂，控制南中。屢次北伐，與魏相攻戰:2902。建興十二年，諸葛亮卒於五丈原軍中，年五十四，谥為忠武:2902。《三國志·蜀志》有傳:2902。後世景仰诸葛亮才能品格，常尊其为武侯、诸葛武侯。後民間小說、戲曲謂其通曉陰陽，料事如神:2902。"鞠躬盡瘁、死而後已"，代表中国传统文化忠臣与智者。明代羅貫中《三國演義》所刻畫者，流傳眾口，最為著稱:2902。毛宗崗评《三国演义》将诸葛亮称为"三绝"中的"智绝"。 葛氏原住在琅琊諸縣，後遷到琅琊陽都，陽都先有葛氏，時人稱諸縣葛氏為諸葛，因之以諸葛為姓:1232。 黎東方在《細説三國》稱，諸葛亮遠祖是商代葛國國君，封邑在今河南省東部:2。諸葛亮是漢司隸校尉諸葛豐後；父親諸葛珪，字君貢，漢末為泰山郡丞:911。 漢靈帝光和四年（181年），諸葛亮生於琅琊陽都:3。不久母親章氏去世，父親續娶:3。中平五年（188年），諸葛亮的父親諸葛珪去世:3-4。一家生活由叔父諸葛玄來照料:911。 袁術與諸葛玄是世交，他請諸葛玄擔任豫章郡太守:4。興平元年（194年），諸葛玄帶著諸葛亮及其弟諸葛均以及他們兩個姐姐隨同上任:4。諸葛瑾留家照顧繼母:4。之後諸葛瑾帶著繼母到江東避難，後來出仕於孫權帳下:4。 之後漢朝更選朱皓代諸葛玄職位:4。諸葛玄素與荊州牧劉表有舊，往依附之:4。諸葛玄許配諸葛亮大姐予中廬蒯祺，許配諸葛亮二姐予龐德公兒子龐山民:5-6。建安二年（197年）諸葛玄死，當時諸葛亮虛歲十七歲:6。諸葛亮躬耕隴畝，好為《梁父吟》；身長八尺（約184公分，漢時一尺約為23。1公分），每自己比作於管仲、樂毅，當時人都不同意；惟有博陵崔州平、穎川徐庶與諸葛亮交好，說是確實這樣:911。 诸葛亮與當時荊州名士司馬徽、龐德公等結交:911。三國志註《襄陽記》記載曰：黃承彥高爽開列，為沔南名士，謂諸葛亮：「聞君擇婦；身有醜女，黃頭黑色，而才堪相配。（聽聞你正要挑選妻子；我有一醜女兒，黃頭髮、黑皮膚，但才華堪相配於你。）」；諸葛亮答應，即迎；時人以為笑樂，鄉里為之諺曰：「莫作孔明擇婦，正得阿承醜女。（不要像諸葛亮那樣選老婆，娶了黃承彥的醜女兒。）」:929 明人作《孔明出山圖》 建安六年（201年），曹操既破袁紹，自南進擊劉備；劉備派遣麋竺、孫乾與劉表相聞，劉表自郊外迎接，以上賓之禮相待，增益其兵馬，使之屯兵新野:876。劉備向司馬徽請教世事。司馬徽說：「我這儒生是淺俗士人，怎麼會懂時勢事務。知道時勢事務的人都是英俊豪傑。在這地方，有臥龍（诸葛亮）、鳳雛（龐統）兩人。」:913徐庶見劉備，劉備器重，徐庶對劉備說：「諸葛孔明，是臥龍，劉將軍希望見到嗎。」；劉備答：「你與他一起過來吧。」；徐庶說：「諸葛亮這個人你需要親自去見他，不能由其他人去做，還委屈將軍您坐車去拜訪他。''',
            'content_length': 2995
        }
    ]
    
    print("📋 原始数据:")
    print(f"数据类型: {type(test_data)}")
    print(f"数据长度: {len(test_data)}")
    print(f"第一个元素类型: {type(test_data[0])}")
    print(f"第一个元素键: {list(test_data[0].keys())}")
    print()
    
    # 测试内容提取
    print("🔍 测试内容提取:")
    print("-" * 40)
    
    extracted_content = _extract_content(test_data)
    print(f"提取的内容长度: {len(extracted_content)}")
    print(f"提取的内容前200字符: {extracted_content[:200]}")
    print()
    
    # 分析提取过程
    print("🔍 分析提取过程:")
    print("-" * 40)
    
    for i, item in enumerate(test_data):
        print(f"处理第{i+1}个元素:")
        print(f"  类型: {type(item)}")
        print(f"  键: {list(item.keys())}")
        
        # 检查每个字段
        for key, value in item.items():
            print(f"  字段 '{key}':")
            print(f"    类型: {type(value)}")
            print(f"    长度: {len(str(value))}")
            if isinstance(value, str):
                print(f"    前50字符: {value[:50]}")
            print()
    
    # 测试提示词构建
    print("🔍 测试提示词构建:")
    print("-" * 40)
    
    prompt = _build_professional_prompt(
        extracted_content, 
        "诸葛亮背景报告", 
        800, 
        "markdown", 
        "professional", 
        "历史人物"
    )
    
    print(f"提示词长度: {len(prompt)}")
    print(f"提示词前500字符: {prompt[:500]}")
    print()
    
    # 分析问题
    print("🔍 问题分析:")
    print("-" * 40)
    
    print("1. 内容提取问题:")
    print("   - 原始数据包含丰富的full_content字段")
    print("   - 但提取的内容可能不完整")
    print("   - 需要检查_extract_text_from_dict函数的逻辑")
    
    print("\n2. 提示词问题:")
    print("   - 提示词可能没有正确传递内容")
    print("   - 需要检查内容长度限制")
    
    print("\n3. 回退机制问题:")
    print("   - 当LLM API不可用时，回退到简单模板")
    print("   - 简单模板没有真正处理内容")

def test_extract_text_from_dict():
    """测试字典文本提取函数"""
    print("\n🔍 测试字典文本提取:")
    print("=" * 60)
    
    from tools.llm_report_generator import _extract_text_from_dict
    
    test_dict = {
        'title': '諸葛亮- 維基百科，自由的百科全書',
        'link': 'https://zh.wikipedia.org/wiki/%E8%AF%B8%E8%91%9B%E4%BA%AE',
        'snippet': ' 諸葛亮是漢司隸校尉諸葛豐後；父親諸葛珪，字君貢，漢末為泰山郡丞。 漢靈帝光和四年（181年），諸葛亮生於琅琊陽都。 不久母親章氏去世，父親續娶。 中平五年（188年），諸葛亮的父\xa0... ',
        'full_content': '諸葛亮蜀漢丞相、政治家、軍事家...',  # 简化版本
        'content_length': 2995
    }
    
    print("测试字典:")
    print(f"键: {list(test_dict.keys())}")
    print()
    
    result = _extract_text_from_dict(test_dict)
    print(f"提取结果: {result}")
    print(f"结果长度: {len(result)}")

if __name__ == "__main__":
    debug_content_extraction()
    test_extract_text_from_dict() 